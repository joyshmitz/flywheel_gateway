# Data Flow

Detailed data flow diagrams for key operations in Flywheel Gateway.

## HTTP Request/Response Flow

### Standard API Request

```
┌─────────┐     ┌────────────────────────────────────────────────┐
│ Client  │     │                  Gateway                       │
└────┬────┘     │ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ │
     │          │ │ Auth │ │ Rate │ │Route │ │Svc   │ │  DB  │ │
     │          │ └──┬───┘ └──┬───┘ └──┬───┘ └──┬───┘ └──┬───┘ │
     │          └────┼────────┼────────┼────────┼────────┼──────┘
     │               │        │        │        │        │
     │── Request ───▶│        │        │        │        │
     │               │──────▶│        │        │        │
     │               │        │───────▶│        │        │
     │               │        │        │───────▶│        │
     │               │        │        │        │───────▶│
     │               │        │        │        │◀───────│
     │               │        │        │◀───────│        │
     │◀── Response ──│◀───────│◀───────│        │        │
```

### Error Response Flow

```
┌─────────┐     ┌────────────────────────────────┐
│ Client  │     │            Gateway             │
└────┬────┘     │ ┌──────┐ ┌──────┐ ┌──────────┐│
     │          │ │ Auth │ │ Rate │ │Error Hndl││
     │          │ └──┬───┘ └──┬───┘ └────┬─────┘│
     │          └────┼────────┼──────────┼──────┘
     │               │        │          │
     │── Request ───▶│        │          │
     │               │───X    │          │ (Invalid token)
     │               │────────│─────────▶│
     │◀── 401 ───────│◀───────│◀─────────│
```

## WebSocket Communication

### Connection Lifecycle

```
┌─────────┐                           ┌─────────────────────┐
│ Client  │                           │      WS Hub         │
└────┬────┘                           └──────────┬──────────┘
     │                                           │
     │── WS Upgrade ────────────────────────────▶│
     │◀─ 101 Switching Protocols ───────────────│
     │                                           │
     │── {"type":"auth","token":"..."} ─────────▶│
     │◀─ {"type":"authenticated"} ──────────────│
     │                                           │
     │── {"type":"subscribe","sessionId":"x"} ──▶│
     │◀─ {"type":"subscribed","sessionId":"x"} ─│
     │                                           │
     │                    (server sends events)  │
     │◀─ {"type":"output","data":"..."} ────────│
     │◀─ {"type":"output","data":"..."} ────────│
     │                                           │
     │◀─ {"type":"heartbeat"} ──────────────────│
     │── {"type":"heartbeat"} ──────────────────▶│
     │                                           │
     │── {"type":"unsubscribe","sessionId":"x"} ▶│
     │◀─ {"type":"unsubscribed"} ───────────────│
     │                                           │
     │── Close ─────────────────────────────────▶│
```

### Multi-Client Broadcasting

```
┌─────────┐ ┌─────────┐ ┌─────────┐
│Client A │ │Client B │ │Client C │
└────┬────┘ └────┬────┘ └────┬────┘
     │           │           │
     │           │           │      ┌─────────────┐
     │           │           │      │   WS Hub    │
     │           │           │      └──────┬──────┘
     │           │           │             │
     │── subscribe("s1") ────│────────────▶│
     │           │── subscribe("s1") ─────▶│
     │           │           │             │
     │           │           │     ┌───────┴───────┐
     │           │           │     │ Session s1    │
     │           │           │     │ emits output  │
     │           │           │     └───────┬───────┘
     │           │           │             │
     │◀──────────│───────────│─── output ──│ (broadcast)
     │           │◀──────────│─── output ──│
```

## Session Execution Flow

### Session State Transitions

```
                          ┌─────────────┐
                          │   Created   │
                          └──────┬──────┘
                                 │
                          ┌──────▼──────┐
                          │   Queued    │
                          └──────┬──────┘
                                 │
           ┌─────────────────────▼──────────────────────┐
           │                  Running                    │
           │                                             │
           │  ┌─────────┐   ┌─────────┐   ┌─────────┐  │
           │  │ Execute │──▶│  Tool   │──▶│ Output  │  │
           │  │  Task   │   │  Calls  │   │  Stream │  │
           │  └─────────┘   └─────────┘   └─────────┘  │
           │                                             │
           └─────────┬──────────┬────────────┬──────────┘
                     │          │            │
              ┌──────▼───┐ ┌────▼─────┐ ┌────▼─────┐
              │Completed │ │  Failed  │ │ Cancelled│
              └──────────┘ └──────────┘ └──────────┘
```

### Task Execution Detail

```
┌──────────────────────────────────────────────────────────────┐
│                       Agent Driver                            │
│                                                               │
│  ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌────────┐ │
│  │  Parse  │────▶│   DCG   │────▶│ Execute │────▶│ Stream │ │
│  │  Task   │     │  Check  │     │ Command │     │ Output │ │
│  └─────────┘     └────┬────┘     └─────────┘     └───┬────┘ │
│                       │                              │       │
│                  ┌────▼────┐                         │       │
│                  │ Blocked │                         │       │
│                  │  Log    │                         │       │
│                  └─────────┘                         │       │
│                                                      │       │
└──────────────────────────────────────────────────────┼───────┘
                                                       │
                                                       ▼
                                                ┌─────────────┐
                                                │  WS Hub     │
                                                │  broadcast  │
                                                └─────────────┘
```

## BYOA Account Flow

### Account Linking (OAuth)

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│ Browser │     │ Gateway │     │Provider │     │   DB    │
└────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘
     │               │               │               │
     │── Start ─────▶│               │               │
     │◀─ Redirect ───│               │               │
     │               │               │               │
     │─────────────────────────────▶│               │
     │               │◀─ Auth Code ──│               │
     │               │               │               │
     │               │── Token Req ─▶│               │
     │               │◀─ Access Tkn ─│               │
     │               │               │               │
     │               │──────────────────────────────▶│
     │               │               │               │ (encrypt & store)
     │◀─ Complete ───│               │               │
```

### Account Rotation

```
┌─────────────────────────────────────────────────────────────┐
│                     Account Pool                             │
│                                                              │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐     │
│  │ Acct 1  │   │ Acct 2  │   │ Acct 3  │   │ Acct 4  │     │
│  │verified │   │cooldown │   │verified │   │  error  │     │
│  │   ★     │   │  (429)  │   │         │   │ (401)   │     │
│  └────┬────┘   └─────────┘   └────┬────┘   └─────────┘     │
│       │                           │                          │
│       └───────────┬───────────────┘                          │
│                   │                                          │
│           ┌───────▼───────┐                                  │
│           │   Selector    │                                  │
│           │ (round-robin) │                                  │
│           └───────┬───────┘                                  │
│                   │                                          │
└───────────────────┼──────────────────────────────────────────┘
                    │
              ┌─────▼─────┐
              │  Request  │
              │   API     │
              └─────┬─────┘
                    │
              ┌─────▼─────┐
              │  429?     │──Yes──▶ Mark cooldown, retry next
              └─────┬─────┘
                    │ No
              ┌─────▼─────┐
              │  Success  │
              └───────────┘
```

## Checkpoint and Recovery

### Checkpoint Creation

```
┌─────────────────────────────────────────────────────────┐
│                    Session Execution                     │
│                                                          │
│  Event 1 ──▶ Event 2 ──▶ Event 3 ──▶ Event 4 ──▶ ...   │
│      │           │           │           │              │
│      ▼           ▼           ▼           ▼              │
│  ┌──────┐    ┌──────┐    ┌──────┐    ┌──────┐         │
│  │ CP 1 │    │ CP 2 │    │ CP 3 │    │ CP 4 │         │
│  │(auto)│    │(tool)│    │(auto)│    │(tool)│         │
│  └──┬───┘    └──┬───┘    └──┬───┘    └──┬───┘         │
│     │           │           │           │              │
└─────┼───────────┼───────────┼───────────┼──────────────┘
      │           │           │           │
      ▼           ▼           ▼           ▼
   ┌──────────────────────────────────────────┐
   │              Checkpoint Store             │
   └──────────────────────────────────────────┘
```

### Recovery Flow

```
┌─────────┐     ┌─────────┐     ┌─────────┐
│ Client  │     │ Gateway │     │   DB    │
└────┬────┘     └────┬────┘     └────┬────┘
     │               │               │
     │── Restore ───▶│               │
     │   CP 2        │── Load CP ───▶│
     │               │◀─ State ──────│
     │               │               │
     │               │── Create ────▶│
     │               │   new session │
     │               │   from state  │
     │               │               │
     │◀─ New Session │               │
     │               │               │
     │── Subscribe ─▶│               │
     │◀─ Resume ─────│               │
```

## DCG (Destructive Command Guard)

### Command Validation Flow

```
┌─────────────────────────────────────────────────────────────┐
│                     DCG Service                              │
│                                                              │
│  ┌─────────┐     ┌─────────────┐     ┌─────────────────┐   │
│  │ Command │────▶│ Rule Engine │────▶│ Decision        │   │
│  │ Input   │     │             │     │                 │   │
│  └─────────┘     │ ┌─────────┐ │     │ ┌─────┐ ┌─────┐│   │
│                  │ │ Git     │ │     │ │Allow│ │Block││   │
│                  │ │ Rules   │ │     │ └──┬──┘ └──┬──┘│   │
│                  │ ├─────────┤ │     └────┼───────┼───┘   │
│                  │ │ FS      │ │          │       │       │
│                  │ │ Rules   │ │          │       │       │
│                  │ ├─────────┤ │          ▼       ▼       │
│                  │ │ DB      │ │     ┌─────────────────┐  │
│                  │ │ Rules   │ │     │ Audit Log       │  │
│                  │ └─────────┘ │     └─────────────────┘  │
│                  └─────────────┘                          │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### Block Response

```
Command: rm -rf /
     │
     ▼
┌─────────────────────────────────────┐
│        DCG Rule Match               │
│  Pattern: rm -rf /[^t]              │
│  Action: BLOCK                      │
│  Reason: Filesystem root deletion   │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│        Block Response               │
│  {                                  │
│    "blocked": true,                 │
│    "command": "rm -rf /",           │
│    "rule": "fs_root_protection",    │
│    "message": "Cannot delete ..."   │
│  }                                  │
└─────────────────────────────────────┘
```
